{"version":3,"file":"index.js","sources":["../src/tab.js","../src/index.js"],"sourcesContent":["// Inspired by https://github.com/tejacques/crosstab/blob/master/src/crosstab.js Copyright 2015 Tom Jacques\n// Copyright 2018 Jacob Wright\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated\n// documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation the\n// rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in all copies or substantial portions of the\n// Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE\n// WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR\n// COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nconst HEARTBEAT_INTERVAL = 500;\nconst TAB_TIMEOUT = 5 * 1000;\nconst PING_TIMEOUT = 50;\n\nconst CLOSE = 'tabClose';\nconst UPDATE = 'tabUpdate';\nconst PROMOTE = 'tabPromoted';\nconst PING = 'ping';\nconst PONG = 'pong';\nconst MESSAGE_KEY = 'election-message';\nconst TABS_KEY = 'election-tabs';\nconst LEADER_KEY = 'election-leader';\n\n\nexport default class Tab {\n\n  constructor(name) {\n    this.id = createTabId();\n    this.name = name;\n    this.tab = { id: this.id };\n\n    this._messageKey = this.name + '-' + MESSAGE_KEY;\n    this._tabsKey = this.name + '-' + TABS_KEY;\n    this._leaderKey = this.name + '-' + LEADER_KEY;\n    this._leaderId = localStorage.getItem(this._leaderKey) || null;\n    this._tabs = parse(localStorage.getItem(this._tabsKey), {});\n    this._tabs[this.id] = this.tab;\n    this._events = {};\n\n    this._onStorage = this._onStorage.bind(this);\n    this.close = this.close.bind(this);\n\n    window.addEventListener('storage', this._onStorage);\n    window.addEventListener('beforeunload', this.close);\n    this.on(PING, this._onPing);\n    this.on(PONG, this._onPong);\n    this.on(UPDATE, this._onTabUpdate);\n    this.on(CLOSE, this._onTabClose);\n    this.on(PROMOTE, this._onTabPromote);\n\n    this._sendHeartbeat();\n  }\n\n  close() {\n    window.removeEventListener('storage', this._onStorage);\n    window.removeEventListener('beforeunload', this.close);\n    clearTimeout(this._heartbeatTimeout);\n\n    if (Object.keys(this._tabs).length === 1) {\n      localStorage.setItem(this._tabsKey, '{}');\n    } else {\n      this.postMessage(CLOSE, this.id);\n    }\n  }\n\n  isLeader() {\n    return this._leaderId === this.id;\n  }\n\n  waitForLeadership(fn) {\n    if (this.isLeader()) fn.call(this);\n    else this.once('promote', () => fn.call(this));\n  }\n\n  on(type, listener) {\n    this._events[type] = getEventListeners(this, type).concat([listener]);\n  }\n\n  once(type, listener) {\n    this.on(type, function wrap() {\n      this.off(type, wrap);\n      listener.apply(this, arguments);\n    });\n  }\n\n  off(type, listener) {\n    this._events[type] = getEventListeners(this, type).filter(l => l !== listener);\n  }\n\n  set(data) {\n    this.tab = Object.assign({}, this.tab, data, { id: this.id, lastUpdated: Date.now() });\n    this.postMessage(UPDATE, this.tab);\n  }\n\n  get() {\n    return this._tabs[this.id];\n  }\n\n  getLeader() {\n    return this._tabs[this._leaderId];\n  }\n\n  getAll() {\n    return this._tabs;\n  }\n\n  emit(type, data) {\n    getEventListeners(this, type).forEach(listener => listener.call(this, data));\n  }\n\n  postMessage(name, data, to) {\n    const newValue = stringify({ name, data, from: this.id, to, timestamp: Date.now() });\n    const oldValue = localStorage.getItem(this._messageKey);\n    localStorage.setItem(this._messageKey, newValue);\n    const event = new Event('storage');\n    event.storageArea = localStorage;\n    event.key = this._messageKey;\n    event.oldValue = oldValue;\n    event.newValue = newValue;\n    window.dispatchEvent(event);\n    localStorage.removeItem(this._messageKey);\n  }\n\n  _sendHeartbeat() {\n    const now = Date.now();\n    clearTimeout(this._heartbeatTimeout);\n    const tabSlow = Object.keys(this._tabs).length / 2;\n    const nextInterval = HEARTBEAT_INTERVAL + Math.round(Math.random() * HEARTBEAT_INTERVAL * tabSlow);\n    this._heartbeatTimeout = setTimeout(() => this._sendHeartbeat(), nextInterval);\n\n    if (!this._tabs[this._leaderId]) {\n      this._runElection();\n    }\n\n    this.tab.lastUpdated = now;\n    this.postMessage(PING, this.tab);\n\n    Object.values(this._tabs).forEach(n => {\n      if (now - n.lastUpdated > TAB_TIMEOUT) this.postMessage(CLOSE, n.id);\n    });\n  }\n\n  _onPing(message) {\n    if (Date.now() - message.timestamp > PING_TIMEOUT) return;\n    const isNew = !this._tabs[message.data.id];\n    this._tabs[message.data.id] = message.data;\n\n    // wait for all the pongs before storing state\n    setTimeout(() => {\n      if (!this._tabs[this._leaderId]) {\n        this._runElection();\n      } else if (this.isLeader()) {\n        this._storeState();\n      }\n    }, PING_TIMEOUT);\n\n    if (message.from !== this.id) {\n      this.tab.lastUpdated = Date.now();\n      this.postMessage(PONG, this.tab);\n      if (isNew) this.emit('change', this.getAll());\n    }\n  }\n\n  _onPong(message) {\n    if (Date.now() - message.timestamp > PING_TIMEOUT) return;\n    const isNew = !this._tabs[message.data.id];\n    this._tabs[message.data.id] = message.data;\n    if (isNew) this.emit('change', this.getAll());\n  }\n\n  _runElection() {\n    const maxId = Object.keys(this._tabs).sort().pop();\n\n    // if we think we should be the leader, set the key and send a message\n    if (this.id === maxId) {\n      localStorage.setItem(LEADER_KEY, this.id);\n      this.postMessage(PROMOTE);\n    }\n\n    // Allow for race conditions and take the last value in localStorage as authoritative\n    setTimeout(() => {\n      // Nobody has taken leadership from us\n      this._leaderId = localStorage.getItem(LEADER_KEY);\n      if (this.isLeader()) {\n        this.emit('promote');\n      }\n    }, PING_TIMEOUT);\n  }\n\n  _onTabUpdate(message) {\n    this._tabs[message.data.id] = message.data;\n\n    if (this.isLeader()) {\n      this._storeState();\n    }\n\n    this.emit('change', this.getAll());\n  }\n\n  _onTabClose(message) {\n    const id = message.data;\n    delete this._tabs[id];\n    if (!this._leaderId || this._leaderId === id) {\n      this._runElection();\n    } else if (this.isLeader()) {\n      this._storeState();\n    }\n    this.emit('change', this.getAll());\n  }\n\n  _onTabPromote() {\n    this._leaderId = localStorage.getItem(LEADER_KEY);\n  }\n\n  _storeState() {\n    localStorage.setItem(TABS_KEY, stringify(this._tabs));\n  }\n\n  _onStorage(event) {\n    if (event.storageArea !== localStorage) return;\n    if (!event.newValue) return;\n    if (event.key !== this._messageKey) return;\n\n    const message = parse(event.newValue);\n    if (!message || message.to && message.to !== this.id) return;\n    this.emit(message.name, message);\n  }\n}\n\nfunction parse(value, defaultValue) {\n  try { return JSON.parse(value) || defaultValue; } catch(e) { return defaultValue; }\n}\n\nfunction stringify(value) {\n  return JSON.stringify(value);\n}\n\nfunction getEventListeners(obj, type) {\n  return obj._events[type] || (obj._events[type] = []);\n}\n\nconst chars = (\n  '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'\n).split('');\n\nfunction createTabId() {\n  let id = '';\n  let length = 8;\n  while (length--) {\n    id += chars[Math.random() * chars.length | 0];\n  }\n  return id;\n}\n","import Tab from './tab';\n\nexport { Tab };\n\n// Shortcut, returns the elector that you can later close, and calls the callback once this tab becomes the leader.\nexport function waitForLeadership(name, callback) {\n  if (typeof name === 'function') {\n    callback = name;\n    name = 'default';\n  }\n  const tab = new Tab(name);\n  tab.waitForLeadership(callback);\n  return tab;\n}\n"],"names":["const","this","let"],"mappings":"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"}